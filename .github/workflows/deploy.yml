вот полный обновлённый `deploy.yml`:

```yaml
name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run tests
        run: |
          export DATABASE_URL="sqlite:///:memory:"
          export SECRET_KEY="test_secret_key"
          export FLASK_ENV="testing"
          python -m pytest -v --cov=app --cov-report=xml || true

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage.xml
          fail_ci_if_error: false

  build-and-push:
    needs: test
    runs-on: ubuntu-22.04
    permissions:
      id-token: write
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: projects/684965854112/locations/global/workloadIdentityPools/github-pool/providers/github-provider
          service_account: github-actions-deployer@sonic-harbor-465608-v1.iam.gserviceaccount.com
          create_credentials_file: true
          export_environment_variables: true
          access_token_scopes: https://www.googleapis.com/auth/cloud-platform

      - name: Set up Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: sonic-harbor-465608-v1
          install_components: 'kubectl,gke-gcloud-auth-plugin'

      - name: Enable GKE auth plugin
        run: echo "USE_GKE_GCLOUD_AUTH_PLUGIN=True" >> $GITHUB_ENV

      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker us-docker.pkg.dev --quiet

      - name: Build and push Docker image
        run: |
          IMAGE=us-docker.pkg.dev/sonic-harbor-465608-v1/flask-blog/flask-blog:${{ github.sha }}
          docker build -t $IMAGE .
          docker push $IMAGE

  deploy:
    needs: build-and-push
    runs-on: ubuntu-22.04
    if: github.ref == 'refs/heads/main'
    permissions:
      id-token: write
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: projects/684965854112/locations/global/workloadIdentityPools/github-pool/providers/github-provider
          service_account: github-actions-deployer@sonic-harbor-465608-v1.iam.gserviceaccount.com
          create_credentials_file: true
          export_environment_variables: true
          access_token_scopes: https://www.googleapis.com/auth/cloud-platform

      - name: Set up Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: sonic-harbor-465608-v1
          install_components: 'kubectl,gke-gcloud-auth-plugin'

      - name: Enable GKE auth plugin
        run: echo "USE_GKE_GCLOUD_AUTH_PLUGIN=True" >> $GITHUB_ENV

      - name: Get GKE credentials
        run: |
          gcloud container clusters get-credentials blog-gke --region europe-west4 --project sonic-harbor-465608-v1

      - name: Deploy to GKE
        run: |
          IMAGE=us-docker.pkg.dev/sonic-harbor-465608-v1/flask-blog/flask-blog:${{ github.sha }}
          kubectl -n blog-dev set image deployment/flask-blog flask-blog=$IMAGE

      - name: Wait for rollout
        run: kubectl -n blog-dev rollout status deployment/flask-blog
```
